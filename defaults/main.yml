---
laravel_deploy_user: 
laravel_deploy_group:
laravel_service_user: "{{ laravel_deploy_user}}"
laravel_service_group: "{{ laravel_deploy_group }}"

laravel_appname: "Sample App"
laravel_app_path: 
laravel_env: local
laravel_secret_key: 
laravel_app_debug: false
hostname: 
db_hostname: 
db_port: 3306
db_database:
db_username:
db_password:
broadcast_driver: file
cache_driver: file
session_driver: file 
session_lifetime: 240
queue_driver: sync
mail_hostname: smtp.umn.edu
sentry_dsn: ""
sentry_samplerate: 0
sentry_profilerate: 0

laravel_require_horizon: false
laravel_require_reberb: false
laravel_require_queue: false
laravel_require_oracle: false

laravel_cron_failure_address:
laravel_env_additions:

php_version: 83
php_packages_unfiltered: 
  - "php{{ php_version }}"
  - "php{{ php_version }}-php-cli"
  - "php{{ php_version }}-php-common"
  - "php{{ php_version }}-php-devel"
  - "php{{ php_version }}-php-mysqlnd"
  - "php{{ php_version }}-php-opcache"
  - "php{{ php_version }}-php-pecl-apcu"
  - "php{{ php_version }}-syspaths"
  - "php{{ php_version }}-php-redis"
  - "php{{ php_version }}-php-process"
  - "php{{ php_version }}-php-zip"
  - "{{ 'php' + php_version|string + '-php-oci8' if laravel_require_oracle | bool else '' }}"

php_packages:  "{{ php_packages_unfiltered | reject('equalto', '') | list }}"

nginx_vhosts:
  - listen: "80"
    server_name: "{{ hostname }}"
    return: "301 https://{{hostname}}$request_uri"
    filename: "{{hostname}}.80.conf"
  - listen: "443 ssl http2"
    server_name: "{{ hostname }}"
    root: "{{laravel_app_path}}/public/"
    index: "index.php index.html index.htm"
    state: "present"
    # realpath param in nginx config is necessary so that it reloads files when symlink is updated
    extra_parameters: |
      location ~ \.php$ {
          fastcgi_split_path_info ^(.+\.php)(/.+)$;
          fastcgi_pass 127.0.0.1:9000;
          fastcgi_index index.php;
          fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
          include fastcgi_params;
      }
      location / {
        try_files $uri $uri/ /index.php?$query_string;
        
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header Scheme $scheme;
        proxy_set_header SERVER_PORT $server_port;
        proxy_set_header REMOTE_ADDR $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_pass http://0.0.0.0:8080;
      }
      error_page 404 /index.php;
      location = /favicon.ico { access_log off; log_not_found off; }
      location = /robots.txt  { access_log off; log_not_found off; }
      location ~ /\.(?!well-known).* {
        deny all;
      }
      ssl_certificate     /etc/letsencrypt/live/{{hostname}}/fullchain.pem;
      ssl_certificate_key /etc/letsencrypt/live/{{hostname}}/privkey.pem;
      ssl_protocols       TLSv1.1 TLSv1.2;
      ssl_ciphers         HIGH:!aNULL:!MD5;

nginx_remove_default_vhost: true
